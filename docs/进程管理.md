## 进程调度

### Rust异步无栈协程调度

TODO

### 任务控制块

在操作系统课上我们知道，进程是操作系统中资源分配的基本单位。每个进程都有自己独立的地址空间和资源，如内存、文件描述符等。线程是操作系统中CPU调度的基本单位。线程共享所在进程的地址空间和资源，但有独立的执行上下文。

在调研其他队的设计时我们发现，很多队都将进程和线程分开设计，分别使用Process和Thread结构体表示。但其实POSIX规范中，并没有严格地区分进程和线程，而是通过一组统一的API来操作任务，例如`sys_clone`系统调用通过不同的 `flags` 组合创建共享不同资源的新任务，因此进程和线程的创建本质上是类似的。统一使用 `Task` 结构体，可以通过标志位决定任务的具体属性，而不需要区分进程结构体和线程结构体。比如，设置 `CLONE_VM` 标志位时，新任务共享父任务的地址空间，这可以通过 `Task` 结构体中的 `memory_space` 字段来实现共享。同样，设置 `CLONE_THREAD` 标志位时，新任务加入父任务的线程组，这可以通过 `Task` 结构体中的 `ThreadGroup` 字段来实现管理。

基于上述分析，我们对进程和线程统一使用`Task`结构体表示，其具体设计如下：

```rust
pub struct Task {
    // Immutable
    /// Task identifier handle.
    tid: TidHandle,
    /// Weak reference to the leader task. `None` if this task is the leader.
    leader: Option<Weak<Task>>,
    /// Indicates if the task is the leader of its thread group.
    is_leader: bool,

    // Mutable
    /// Indicates if the task is a zombie. Protected by a spin lock due to potential access by other tasks.
    state: SpinNoIrqLock<TaskState>,
    /// The address space of the process.
    memory_space: Shared<MemorySpace>,
    /// Map of start address of shared memory areas to their keys in the shared memory manager.
    shm_ids: Shared<BTreeMap<VirtAddr, usize>>,
    /// Parent task.
    parent: Shared<Option<Weak<Task>>>,
    /// Child tasks.
    children: Shared<BTreeMap<Tid, Arc<Task>>>,
    /// Exit code of the task.
    exit_code: AtomicI32,
    /// Trap context for the task.
    trap_context: SyncUnsafeCell<TrapContext>,
    /// Waker to add the task back to the scheduler.
    waker: SyncUnsafeCell<Option<Waker>>,
    /// Thread group containing this task.
    thread_group: Shared<ThreadGroup>,
    /// File descriptor table.
    fd_table: Shared<FdTable>,
    /// Current working directory.
    cwd: Shared<Arc<dyn Dentry>>,
    /// Pending signals for the task.
    sig_pending: SpinNoIrqLock<SigPending>,
    /// Signal handlers. Shared if `CLONE_SIGHAND` flag is set or among threads in the same group.
    sig_handlers: Shared<SigHandlers>,
    /// Signal mask indicating which signals are blocked.
    sig_mask: SyncUnsafeCell<SigSet>,
    /// Optional signal stack for the task, settable via `sys_signalstack`.
    sig_stack: SyncUnsafeCell<Option<SignalStack>>,
    /// Pointer to the user context for signal handling.
    sig_ucontext_ptr: AtomicUsize,
    /// Statistics for task execution times.
    time_stat: SyncUnsafeCell<TaskTimeStat>,
    /// Interval timers for the task.
    itimers: Shared<[ITimer; 3]>,
    /// Futexes used by the task.
    futexes: Shared<Futexes>,
    /// Address to store the task identifier.
    tid_address: SyncUnsafeCell<TidAddress>,
    /// Allowed CPUs for the task.
    cpus_allowed: SyncUnsafeCell<CpuMask>,
}
```

下面介绍一下Task结构体各个字段的含义。

首先Task结构体被大致划分为不可变（Immutable）和可变（Mutable）两部分：

- **不可变部分**：不可变字段在任务创建后不会改变，因此可以保证数据的一致性。这些字段通常包括任务的基本标识信息，如 `tid`（任务ID）和 `is_leader`（是否为领导者）。由于这些字段不会改变，多线程环境下访问这些字段时不需要加锁，可以提高访问效率和安全性。

| 字段名      | 含义                                                    |
| ----------- | ------------------------------------------------------- |
| `tid`       | 任务的唯一标识符（任务ID）。                            |
| `leader`    | 对领导者任务的弱引用。如果该任务是领导者，则为 `None`。 |
| `is_leader` | 标识任务是否是线程组的领导者。                          |

- **可变部分**：可变字段涉及任务的状态和资源管理，如 `state`（任务状态）、`memory_space`（内存空间）和 `children`（子任务）。这些字段在任务的生命周期内可能会改变，需要使用锁机制来保证线程安全。

| 字段名             | 含义                                                         |
| ------------------ | ------------------------------------------------------------ |
| `state`            | 任务的当前状态（例如，运行中、等待中、僵尸状态等），由自旋锁保护以确保线程安全。 |
| `memory_space`     | 任务的地址空间。                                             |
| `shm_ids`          | 共享内存区域起始地址到共享内存管理器中的键的映射。           |
| `parent`           | 父任务。                                                     |
| `children`         | 子任务。                                                     |
| `exit_code`        | 任务的退出代码。                                             |
| `trap_context`     | 任务的陷阱上下文。                                           |
| `waker`            | 用于将任务重新添加到调度器的唤醒器。                         |
| `thread_group`     | 包含该任务的线程组。                                         |
| `fd_table`         | 文件描述符表。                                               |
| `cwd`              | 当前工作目录。                                               |
| `sig_pending`      | 任务的挂起信号。                                             |
| `sig_handlers`     | 信号处理程序表。如果设置了 `CLONE_SIGHAND` 标志或者任务在同一线程组中，则这些处理程序是共享的。 |
| `sig_mask`         | 信号屏蔽，用于指示哪些信号被阻塞。                           |
| `sig_stack`        | 任务的可选信号栈，通过 `sys_signalstack` 设置。              |
| `sig_ucontext_ptr` | 信号处理的用户上下文指针。                                   |
| `time_stat`        | 任务执行时间的统计信息。                                     |
| `itimers`          | 任务的间隔定时器。                                           |
| `futexes`          | 任务使用的轻量级锁（futexes）。                              |
| `tid_address`      | 存储任务标识符的地址。                                       |
| `cpus_allowed`     | 任务允许运行的CPU集合。                                      |