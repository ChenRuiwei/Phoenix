# 物理内存管理

## 内核动态内存分配器

Phoenix 使用伙伴分配器管理内核所需的动态内存结构，来自 crate `buddy_system_allocator`。

伙伴分配器（Buddy Allocator）是一种内存分配算法，常用于操作系统内核和高性能应用程序中，通过分配和管理内存块来满足不同大小的内存请求，并进行高效的合并和分割操作。其工作原理是将内存块按照 2 的幂次方大小分为多个层级，当需要分配特定大小的内存时，从最小适合该请求的层级开始查找。每个内存块都有一个“伙伴”块，如果块大小是 2^k，那么它的伙伴块也是 2^k 且紧挨着它。通过检查和计算伙伴块的地址，可以快速地进行内存分割与合并。当需要分配的内存块小于当前可用最小块时，将当前块一分为二，直到找到合适大小的块为止；当释放一个内存块时，若其伙伴块也空闲，则将两个块合并为一个更大的块，递归进行直到不能再合并为止。伙伴分配器的优点在于分配和释放内存块的操作非常快速，且通过内存块大小的选择和合并操作，有效减少了外部碎片。

## 物理页分配器

内核还需要管理全部的空闲物理内存，Phoenix 为此使用了 来自 rCore 的仓库的
`bitmap-allocator`。 Phoenix 在内核初始化时，会将所有内核未占用的物理内存加入物理页分配器。

Bitmap allocator 的主要原理是通过一个位图来管理一段连续的内存空间。这个位图中的每一位代表一块内存，如果该位为 0,说明对应的内存块空闲；如果该位为 1,说明对应的内存块已经被分配出去。当需要分配一个指定大小的内存时，bitmap allocator 首先检查位图中是否有足够的连续空闲内存块可以满足分配请求。如果有，就将对应的位图标记为已分配，并返回该内存块的起始地址；如果没有，就返回空指针，表示分配失败。当需要释放已经分配出去的内存时，bitmap allocator 将对应位图标记为未分配。这样，已经释放的内存块就可以被下一次分配请求使用了。
